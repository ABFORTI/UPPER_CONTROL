graph TD
    Start([XML File]) --> Load[Cargar XML]
    Load --> Check{¿XML válido?}
    Check -->|No| Error[Log error y retornar null]
    Check -->|Sí| DetectVersion{Detectar versión CFDI}
    
    DetectVersion -->|3.3| V33[Namespace CFDI 3.3]
    DetectVersion -->|4.0| V40[Namespace CFDI 4.0]
    
    V33 --> ParseComprobante[Extraer Comprobante:<br/>- Folio<br/>- Fecha<br/>- FormaPago<br/>- MetodoPago<br/>- TipoCambio<br/>- Moneda]
    V40 --> ParseComprobante
    
    ParseComprobante --> ParseEmisor[Extraer Emisor:<br/>- RFC<br/>- Nombre<br/>- RegimenFiscal]
    ParseEmisor --> ParseReceptor[Extraer Receptor:<br/>- RFC<br/>- Nombre<br/>- UsoCFDI<br/>- DomicilioFiscal<br/>- RegimenFiscal]
    
    ParseReceptor --> ParseConceptos[Extraer Conceptos:<br/>Loop sobre items]
    ParseConceptos --> ForEachConcepto{Para cada concepto}
    
    ForEachConcepto --> ConceptoData[Extraer:<br/>- Cantidad<br/>- Unidad<br/>- Descripción<br/>- ValorUnitario<br/>- Importe<br/>- ObjetoImp]
    ConceptoData --> ForEachConcepto
    
    ForEachConcepto -->|Fin| ParseImpuestos[Extraer Impuestos:<br/>- TotalImpTraslados<br/>- TotalImpRetenidos]
    
    ParseImpuestos --> ParseTimbre[Extraer Timbre Fiscal:<br/>- UUID<br/>- FechaTimbrado<br/>- SelloCFD<br/>- SelloSAT<br/>- NoCertSAT<br/>- RfcProvCertif]
    
    ParseTimbre --> FormatData[Formatear datos:<br/>- Totales<br/>- Fechas<br/>- Montos]
    
    FormatData --> Return[Retornar array<br/>con todos los datos]
    Return --> End([Datos procesados])
    
    Error --> End
    
    style Start fill:#2196f3,stroke:#1565c0,color:#fff
    style End fill:#4caf50,stroke:#2e7d32,color:#fff
    style Error fill:#f44336,stroke:#c62828,color:#fff
    style ParseTimbre fill:#ff9800,stroke:#e65100,color:#fff
