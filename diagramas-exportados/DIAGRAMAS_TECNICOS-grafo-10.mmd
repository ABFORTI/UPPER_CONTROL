graph LR
    Request[HTTP Request] --> M1[StartSession]
    M1 --> M2[ShareErrorsFromSession]
    M2 --> M3[VerifyCsrfToken]
    M3 --> M4[SubstituteBindings]
    M4 --> M5[HandleInertiaRequests]
    
    M5 --> Auth{Ruta protegida?}
    Auth -->|No| Controller
    Auth -->|Sí| M6[Authenticate]
    
    M6 --> Role{Requiere rol?}
    Role -->|No| Controller
    Role -->|Sí| M7[EnsureUserHasRole]
    
    M7 --> Permission{Requiere permiso?}
    Permission -->|No| Controller
    Permission -->|Sí| M8[Permission Middleware]
    
    M8 --> Controller[Controller]
    Controller --> Policy[Policy Check]
    Policy --> Action[Controller Action]
    Action --> Response[Response]
    
    Response --> M9[HandleInertiaRequests]
    M9 --> M10[AddQueuedCookiesToResponse]
    M10 --> M11[EncryptCookies]
    M11 --> Output[HTTP Response]
    
    style Request fill:#4caf50,stroke:#2e7d32,color:#fff
    style Output fill:#4caf50,stroke:#2e7d32,color:#fff
    style M6 fill:#ff9800,stroke:#e65100,color:#fff
    style M7 fill:#f44336,stroke:#c62828,color:#fff
    style M8 fill:#f44336,stroke:#c62828,color:#fff
