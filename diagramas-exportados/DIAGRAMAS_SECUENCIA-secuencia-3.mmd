sequenceDiagram
    actor TeamLeader
    participant Browser
    participant OrdenController
    participant EvidenciaController
    participant Orden
    participant Avance
    participant Evidencia
    participant DB
    participant Storage
    participant Notification
    actor Calidad

    TeamLeader->>Browser: Accede a /ordenes/{id}
    Browser->>OrdenController: GET show(orden)
    OrdenController->>DB: Cargar orden completa
    DB-->>OrdenController: Orden con avances y evidencias
    OrdenController-->>Browser: Render vista orden
    Browser-->>TeamLeader: Mostrar detalles OT
    
    TeamLeader->>Browser: Completar formulario avance:<br/>- Porcentaje<br/>- Descripción
    Browser->>OrdenController: POST registrarAvance(orden, request)
    
    OrdenController->>Avance: Create avance
    Avance->>DB: INSERT avance
    
    OrdenController->>Orden: Update progreso
    Orden->>DB: UPDATE progreso
    
    OrdenController->>OrdenController: Check if progreso >= 100
    
    alt Progreso >= 100%
        OrdenController->>Orden: Update estado = 'completada'
        Orden->>DB: UPDATE estado
        OrdenController->>Notification: OtListaParaCalidad
        Notification->>Calidad: 📧 Email a calidad
        Notification->>DB: Guardar notificación
    end
    
    OrdenController-->>Browser: Success response
    Browser-->>TeamLeader: "Avance registrado"
    
    TeamLeader->>Browser: Seleccionar archivos evidencia
    Browser->>EvidenciaController: POST store(orden, files)
    
    loop Para cada archivo
        EvidenciaController->>Storage: Guardar archivo
        Storage-->>EvidenciaController: Path guardado
        
        EvidenciaController->>Evidencia: Create evidencia
        Evidencia->>DB: INSERT evidencia
    end
    
    EvidenciaController-->>Browser: Success
    Browser-->>TeamLeader: "Evidencias subidas"
    
    Note over Calidad: Recibe notificación cuando<br/>progreso llega a 100%
